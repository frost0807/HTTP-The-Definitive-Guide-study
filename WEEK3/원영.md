# 5장 웹 서버

모든 웹 서버는 리소스에 대한 HTTP 요청을 받아서 콘텐츠를 클라이언트에게 돌려준다.

# 6장 캐시

캐시는 네트워크 병목 해결, 서버 요청 감소, 더 빠른 응답 같은 혜택을 제공한다.

- 불필요한 데이터 전송
- 대역폭 병목
- 트래픽 폭증
- 거리로 인한 지연
- cache hit, cache miss

## 재검사(Revalidation)

캐시된 데이터가 최신인지 서버를 통해 점검해야 하는데,
이러한 검사를 재검사 라고 한다.
캐시는 캐시 사본의 재검사가 필요할 때, 원 서버에 작은 재검사 요청을 보내는데
만약 아직 유효하다면(변경되지 않았다면) 304 Not Modified 를 응답하고
캐시는 그 사본을 클라이언트에게 제공한다.
이를 재검사 적중 혹은 느린 적중이라고 한다.
이것은 순수 캐시 적중보단 느리고 캐시부적중보단 빠르다.

캐시된 데이터를 확인하기 위해 가장 많이 쓰이는 헤더는 If-Modified-Since 헤더다.
GET요청에 실어서 보내면 캐시된 시간 이후에 변경된 경우에만 사본을 보내달라는 의미가 된다.

GET If-Modified-Since 요청의 세 가지 경우

- 서버 콘텐츠가 변경되지 않은 경우
  - 변경되지 않았다면 서버는 작은 HTTP 304 Not Modified 응답을 보낸다.
- 서버 콘텐츠가 변경된 경우
  - 변경되었다면 서버는 콘텐츠 전체와 함께 평볌한 HTTP 200 OK 를 응답으로 보낸다.
- 객체가 삭제된 경우
  - 삭제되었다면 서버는 HTTP 404 Not Found 를 보낸다.

## 적중률

캐시 적중률이 100%에 가까울수록 좋지만 40%면 웹 캐시로 괜찮은 성능

## 적중과 부적중 구별

HTTP는 응답이 캐시에서 왔는지 원 서버에서 왔는지를 클라이언트에게 알려주지 않음
알 수 있는 방법은

- 응답의 Date 헤더와 현재 시간을 비교해서 응답의 생성일이 현재 시간보다 더 오래되었다면 캐시된 응답일 수 있다.
- 응답이 얼마나 오래되었는지를 말해주는 Age 헤더를 본다.

## 캐시 처리 단계

1. 요청 받기
2. 파싱
3. 검색
4. 신선도 검사
5. 응답 생성
6. 전송
7. 로깅

요청 -> 캐시가 안되어있으면 원서버로 요청해서 가져옴
요청 -> 캐시 되어있으면 -> 신선도 검사 -> 신선하면 그대로 응답
요청 -> 캐시 되어있으면 -> 신선도 검사 -> 신선하지 않으면 -> 서버에 재검사

## 사본을 신선하게 유지하기

- 문서 만료
  - HTTP는 Cache-Control 과 Expires 헤더를 사용해 원 서버가 각 문서에 유효기간을 붙일 수 있게 해준다.
- 서버 재검사
  - 캐시된 문서의 유효기간이 만료되었다는게 그 문서가 원 서버의 원본과 실제로 다르다는걸 의미하는건 아님
  - 다만 이제 검사할 시간이 되었음을 뜻한다.

## 조건부 GET

- 조건부 GET은 헤더에 조건부 헤더를 추가함으로써 캐시가 갖고 있는 문서와 원 서버의 문서가 다를 경우에만 본문을 보내달라고 하는 요청이다.
- HTTP는 5가지 조건부 헤더를 제공하고, 캐시 재검사를 할 때 가장 유용한 헤더는 If-Modified-Since 와 If-None-Match 이다.

## If-Modified-Since(IMS)

- 만약 문서가 주어진 날짜 이후에 변경되었다면 IMS 조건은 참이고 GET 요청은 새로운 문서와 새로운 만료 날짜로 캐시에게 반환 됨.
- 만약 문서가 주어진 날짜 이후에 변경되지 않았다면 IMS 조건은 거짓이고 서버는 작은 304 Not Modified 를 응답하게 된다.
- IMS 헤더는 보통 서버측의 Last-Modified 헤더와 같이 동작하게 된다.

## IF-None-Match : 엔터티 태그 재검사

- 특정 엔터티 태그를 문자열로 표현해서 ex) 예를들어 버전 등을 비교해서 검사할 수 있다.

## 캐시 제어

- Cache-Control: no-store
  - 캐시가 응답의 사본을 만드는것을 금지한다.
  - 클라이언트에게 no-store 응답을 전달하고 나면 객체를 삭제한다.
- Cache-Control: no-cache
  - 로컬 캐시 저장소에 저장될 수 있지만, 먼저 서버와 재검사를 하지 않고서는 캐시에서 클라이언트로 제공될 수 없다.
- Cache-Control: max-age
  - 신선한 문서가 서버로부터 응답 받은 후로 흐른 시간을 초로 나타낸다.
  - max-age를 0으로 설정함으로써 캐시가 매 접근마다 문서를 캐시하거나 리프레시하는걸 막을 수 있음.
- Cache-Control: must-revalidate
  - 캐시가 이 객체의 신선하지 않은 사본을 원 서버와의 최초의 재검사 없이는 제공해서는 안됨을 의미한다.
- 휴리스틱 만료
  - 응답이 Cache-Control: max-age 헤더나 Expires 헤더를 포함하고 있지 않다면,
    캐시는 경험적으로 최대 나이를 계산한다.
    계산 결과 최대 나이 값이 24시간보다 크다면 Heuristic Expiration 경고 헤더가 응답 헤더에 추가되어야 한다.
